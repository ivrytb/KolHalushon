<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>××¨×›×– ×”×©×™×¢×•×¨×™× - ×§×•×œ ×”×œ×©×•×Ÿ</title>
    <style>
        :root { --primary: #1a3a5f; --secondary: #28a745; --bg: #f1f3f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: auto; }
        #player-box { position: sticky; top: 10px; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 5px 25px rgba(0,0,0,0.2); z-index: 1000; margin-bottom: 20px; display: none; text-align: center; }
        video { width: 100%; max-height: 350px; border-radius: 8px; background: #000; }
        .tabs { display: flex; gap: 10px; margin-bottom: 15px; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: white; cursor: pointer; font-weight: bold; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .tab-btn.active { background: var(--primary); color: white; }
        .quick-ravs { display: flex; gap: 8px; margin-bottom: 20px; overflow-x: auto; padding: 5px; }
        .rav-chip { background: #dee2e6; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 14px; white-space: nowrap; border: 1px solid #ced4da; }
        .search-container { background: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: none; gap: 10px; }
        input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        .item-card { background: white; padding: 15px; border-radius: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border-right: 5px solid var(--primary); }
        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-play { background: var(--secondary); color: white; }
        #status { text-align: center; padding: 20px; color: #666; font-weight: bold; }
    </style>
</head>
<body>
<div class="container">
    <div id="player-box">
        <div id="playing-now" style="margin-bottom:10px; font-weight:bold;"></div>
        <video id="main-video" controls autoplay></video>
        <button class="btn" style="margin-top:10px; background:#eee;" onclick="closePlayer()">×¡×’×•×¨ × ×’×Ÿ</button>
    </div>
    <div class="tabs">
        <button class="tab-btn active" onclick="changeTab('live', this)">ğŸ”´ ×©×™×“×•×¨×™× ×—×™×™×</button>
        <button class="tab-btn" onclick="changeTab('search', this)">ğŸ” ×—×™×¤×•×© ×¨×‘× ×™×</button>
    </div>
    <div class="quick-ravs">
        <div class="rav-chip" onclick="loadRav(634)">ğŸ° ×”××“××•"×¨ ××¡××¡×•×‘</div>
        <div class="rav-chip" onclick="loadRav(1116)">ğŸ”¯ ×”××“××•"×¨ ××‘×™××œ×</div>
        <div class="rav-chip" onclick="loadRav(4746)">ğŸ“œ ×”×¨×‘ ×™×¦×—×§ ×¨×¦××‘×™</div>
    </div>
    <div id="search-section" class="search-container">
        <input type="text" id="search-query" placeholder="×”×§×œ×“ ×©× ×¨×‘...">
        <button class="btn btn-play" onclick="searchRavs()">×—×¤×©</button>
    </div>
    <div id="status">×˜×•×¢×Ÿ × ×ª×•× ×™× ××§×•×œ ×”×œ×©×•×Ÿ...</div>
    <div id="content-list"></div>
</div>

<script>
    // ×¤×•× ×§×¦×™×™×ª ×”×§×¡× ×©×¢×•×§×¤×ª CORS ×‘× ×˜×¤×¨×™ - JSONP
    function jsonpRequest(url, callbackName) {
        return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            const name = "callback_" + Math.round(100000 * Math.random());
            window[name] = function(data) {
                resolve(data);
                document.body.removeChild(script);
                delete window[name];
            };
            script.src = `${url}${url.includes('?') ? '&' : '?'}callback=${name}`;
            script.onerror = () => reject();
            document.body.appendChild(script);
        });
    }

    const API_URL = "https://www.kolhalashon.com/api/";

    async function changeTab(mode, btn) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('search-section').style.display = (mode === 'search') ? 'flex' : 'none';
        if (mode === 'live') loadLive();
    }

    async function loadLive() {
        document.getElementById('status').innerText = "×˜×•×¢×Ÿ ×©×™×“×•×¨×™× ×—×™×™×...";
        // ×©×™× ×•×™ ×œ×¤×•×¨××˜ JSONP
        const data = await jsonpRequest(API_URL + "LiveShiurim/WebSite_GetLiveShiurim/1/true/true/30/-1");
        render(data);
    }

    async function searchRavs() {
        const q = document.getElementById('search-query').value;
        document.getElementById('status').innerText = "××—×¤×©...";
        const data = await jsonpRequest(API_URL + "Ravs/WebSite_GetRavs/1/" + encodeURIComponent(q));
        const list = document.getElementById('content-list');
        list.innerHTML = '';
        data?.forEach(rav => {
            const d = document.createElement('div');
            d.className = 'item-card';
            d.innerHTML = `<span>${rav.RavName}</span><button class="btn btn-play" onclick="loadRav(${rav.RavId})">×©×™×¢×•×¨×™×</button>`;
            list.appendChild(d);
        });
        document.getElementById('status').innerText = "";
    }

    async function loadRav(id) {
        document.getElementById('status').innerText = "×˜×•×¢×Ÿ ×©×™×¢×•×¨×™×...";
        const data = await jsonpRequest(API_URL + `Ravs/WebSite_GetRavShiurim/${id}/0/50/1/-1`);
        render(data);
    }

    function render(items) {
        const list = document.getElementById('content-list');
        list.innerHTML = '';
        document.getElementById('status').innerText = "";
        items?.forEach(item => {
            const title = item.Title || item.ShiurTitle;
            const card = document.createElement('div');
            card.className = 'item-card';
            card.innerHTML = `<span>${title}</span><button class="btn btn-play" onclick="play('${item.ShiurId || item.FileId}', '${title}')">â–¶ × ×’×Ÿ</button>`;
            list.appendChild(card);
        });
    }

    async function play(id, title) {
        const res = await jsonpRequest(API_URL + "files/getLocationOfFileToVideo/" + id);
        const player = document.getElementById('main-video');
        document.getElementById('player-box').style.display = 'block';
        document.getElementById('playing-now').innerText = title;
        player.src = res.url || res;
        window.scrollTo(0,0);
    }

    function closePlayer() {
        document.getElementById('player-box').style.display = 'none';
        document.getElementById('main-video').pause();
    }

    loadLive();
</script>
</body>
</html>
