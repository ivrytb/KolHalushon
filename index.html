<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>××¨×›×– ×”×©×™×¢×•×¨×™× - ×§×•×œ ×”×œ×©×•×Ÿ</title>
    <style>
        :root { --primary: #1a3a5f; --secondary: #28a745; --bg: #f1f3f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; text-align: right; }
        .container { max-width: 900px; margin: auto; }
        #player-box { position: sticky; top: 10px; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 5px 25px rgba(0,0,0,0.2); z-index: 1000; margin-bottom: 20px; display: none; text-align: center; }
        video { width: 100%; max-height: 350px; border-radius: 8px; background: #000; }
        .tabs { display: flex; gap: 10px; margin-bottom: 15px; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: white; cursor: pointer; font-weight: bold; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .tab-btn.active { background: var(--primary); color: white; }
        .quick-ravs { display: flex; gap: 8px; margin-bottom: 20px; overflow-x: auto; padding: 5px; }
        .rav-chip { background: #dee2e6; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 14px; white-space: nowrap; border: 1px solid #ced4da; }
        .item-card { background: white; padding: 15px; border-radius: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border-right: 5px solid var(--primary); }
        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-play { background: var(--secondary); color: white; }
        #status { text-align: center; padding: 20px; color: #666; font-weight: bold; border: 1px dashed #ccc; margin-top: 10px; }
    </style>
</head>
<body>
<div class="container">
    <div id="player-box">
        <div id="playing-now" style="margin-bottom:10px; font-weight:bold;"></div>
        <video id="main-video" controls autoplay></video>
        <button class="btn" style="margin-top:10px; background:#eee;" onclick="closePlayer()">×¡×’×•×¨ × ×’×Ÿ</button>
    </div>
    <div class="tabs">
        <button class="tab-btn active" onclick="changeTab('live', this)">ğŸ”´ ×©×™×“×•×¨×™× ×—×™×™×</button>
        <button class="tab-btn" onclick="changeTab('search', this)">ğŸ” ×—×™×¤×•×© ×¨×‘× ×™×</button>
    </div>
    <div class="quick-ravs">
        <div class="rav-chip" onclick="loadRav(634)">ğŸ° ×”××“××•"×¨ ××¡××¡×•×‘</div>
        <div class="rav-chip" onclick="loadRav(1116)">ğŸ”¯ ×”××“××•"×¨ ××‘×™××œ×</div>
        <div class="rav-chip" onclick="loadRav(4746)">ğŸ“œ ×”×¨×‘ ×™×¦×—×§ ×¨×¦××‘×™</div>
    </div>
    <div id="search-section" style="display:none; margin-bottom:20px;">
        <input type="text" id="search-query" style="width:70%; padding:10px;" placeholder="×©× ×”×¨×‘...">
        <button class="btn btn-play" onclick="searchRavs()">×—×¤×©</button>
    </div>
    <div id="status">×™×•×–× ×—×™×‘×•×¨ ×¨××©×•× ×™...</div>
    <div id="content-list"></div>
</div>

<script>
    // ×”×’×“×¨×” ×’×œ×•×‘×œ×™×ª ×œ×˜×™×¤×•×œ ×‘× ×ª×•× ×™× ×©×—×•×–×¨×™×
    window.handleData = function(data) {
        console.log("Data received:", data);
        render(data);
    };

    function callApi(endpoint) {
        console.log("Calling endpoint:", endpoint);
        document.getElementById('status').innerText = "×©×•×œ×— ×‘×§×©×” ×œ×§×•×œ ×”×œ×©×•×Ÿ...";
        
        // ×”×¡×¨×ª ×¡×§×¨×™×¤×˜×™× ×§×•×“××™× ×›×“×™ ×œ× ×œ×”×¢××™×¡
        const oldScript = document.getElementById('jsonp-script');
        if (oldScript) oldScript.remove();

        const script = document.createElement('script');
        script.id = 'jsonp-script';
        // ×”×•×¡×¤×ª Timestamp ×›×“×™ ×œ×× ×•×¢ ×©××™×¨×” ×‘×–×™×›×¨×•×Ÿ (Cache)
        const url = `https://www.kolhalashon.com/api/${endpoint}${endpoint.includes('?') ? '&' : '?'}callback=handleData&_=${Date.now()}`;
        script.src = url;
        
        script.onerror = function() {
            console.error("Script failed to load");
            document.getElementById('status').innerText = "×©×’×™××”: ×”××ª×¨ ×—×¡×•× ××• ×©××™×Ÿ ×—×™×‘×•×¨.";
        };

        document.body.appendChild(script);
    }

    function changeTab(mode, btn) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('search-section').style.display = (mode === 'search') ? 'block' : 'none';
        if (mode === 'live') loadLive();
    }

    function loadLive() {
        callApi("LiveShiurim/WebSite_GetLiveShiurim/1/true/true/30/-1");
    }

    function searchRavs() {
        const q = document.getElementById('search-query').value;
        callApi("Ravs/WebSite_GetRavs/1/" + encodeURIComponent(q));
    }

    function loadRav(id) {
        callApi(`Ravs/WebSite_GetRavShiurim/${id}/0/50/1/-1`);
    }

    function render(items) {
        const list = document.getElementById('content-list');
        list.innerHTML = '';
        document.getElementById('status').innerText = "";
        
        if (!items || items.length === 0) {
            document.getElementById('status').innerText = "×œ× × ××¦××• × ×ª×•× ×™×.";
            return;
        }

        items.forEach(item => {
            const title = item.Title || item.ShiurTitle || "×©×™×¢×•×¨";
            const id = item.ShiurId || item.FileId;
            const card = document.createElement('div');
            card.className = 'item-card';
            card.innerHTML = `
                <span>${title}</span>
                <button class="btn btn-play" onclick="playMedia('${id}', '${title}')">â–¶ × ×’×Ÿ</button>
            `;
            list.appendChild(card);
        });
    }

    function playMedia(id, title) {
        window.handlePlayerData = function(res) {
            const url = res.url || res;
            const player = document.getElementById('main-video');
            document.getElementById('player-box').style.display = 'block';
            document.getElementById('playing-now').innerText = title;
            player.src = url;
            window.scrollTo(0,0);
        };
        
        const script = document.createElement('script');
        script.src = `https://www.kolhalashon.com/api/files/getLocationOfFileToVideo/${id}?callback=handlePlayerData`;
        document.body.appendChild(script);
    }

    function closePlayer() {
        document.getElementById('player-box').style.display = 'none';
        document.getElementById('main-video').pause();
    }

    // ×”×¤×¢×œ×” ××•×˜×•××˜×™×ª ×‘×˜×¢×™× ×”
    window.onload = loadLive;
</script>
</body>
</html>
