<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>××¨×›×– ×”×©×™×¢×•×¨×™× ×”××¢×•×“×›×Ÿ</title>
    <style>
        body { font-family: 'Segoe UI', system-ui; background: #f0f2f5; margin: 0; padding: 20px; direction: rtl; }
        .container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .header { display: flex; gap: 10px; margin-bottom: 20px; }
        input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px; }
        button { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; background: #1a73e8; color: white; }
        .item-card { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #eee; }
        .play-btn { color: #1e8e3e; cursor: pointer; font-weight: bold; padding: 5px 10px; border: 1px solid #1e8e3e; border-radius: 5px; }
        #player { display: none; margin-bottom: 20px; background: #000; border-radius: 8px; padding: 10px; text-align: center; }
        video { width: 100%; border-radius: 4px; max-height: 400px; }
    </style>
</head>
<body>
<div class="container">
    <div id="player">
        <video id="v" controls autoplay></video>
        <button onclick="closePlayer()" style="margin-top:10px; background:#444;">×¡×’×•×¨ × ×’×Ÿ</button>
    </div>
    <div class="header">
        <button style="background:#d93025;" onclick="loadData('LiveShiurim/WebSite_GetLiveShiurim/1/true/true/30/-1')">ğŸ”´ ×©×™×“×•×¨×™× ×—×™×™×</button>
        <input type="text" id="q" placeholder="×—×¤×© ×¨×‘ ××• × ×•×©×...">
        <button onclick="search()">×—×¤×©</button>
    </div>
    <div id="status" style="text-align:center; color:#666; margin: 10px 0;"></div>
    <div id="list"></div>
</div>

<script>
    const PROXY = "/api/proxy?endpoint=";

    async function loadData(endpoint) {
        const status = document.getElementById('status');
        status.innerText = "×˜×•×¢×Ÿ...";
        try {
            const r = await fetch(PROXY + encodeURIComponent(endpoint));
            const data = await r.json();
            status.innerText = "";
            render(data);
        } catch (e) {
            status.innerText = "×©×’×™××” ×‘×˜×¢×™× ×”.";
        }
    }

    function search() {
        const val = document.getElementById('q').value;
        // ×©×™× ×•×™ × ×ª×™×‘ ×”×—×™×¤×•×© ×œ× ×ª×™×‘ ×”××¢×•×“×›×Ÿ ×©×œ 2026
        if (val) loadData(`Ravs/WebSite_GetRavs/1/${encodeURIComponent(val)}/false`);
    }

    function render(data) {
        const list = document.getElementById('list');
        list.innerHTML = '';
        if (!data || data.length === 0) {
            document.getElementById('status').innerText = "×œ× × ××¦××• ×ª×•×¦××•×ª.";
            return;
        }
        data.forEach(item => {
            const div = document.createElement('div');
            div.className = 'item-card';
            
            const name = item.UserNameHebrew || item.RavName || item.CatDesc1 || "×©×™×¢×•×¨";
            const sub = item.MainTopicHebrew || item.CatDesc2 || "";
            // ×˜×™×¤×•×œ ×‘××–×”×™× ×”×—×“×©×™× (FileId ×™×›×•×œ ×œ×”×™×•×ª ××¡×¤×¨ ××¨×•×š ×××•×“)
            const id = item.FileId || item.ShiurId || item.RavId;
            const isRav = !!item.RavId && !item.FileId;

            div.innerHTML = `
                <div>
                    <strong>${name}</strong><br><small>${sub}</small>
                </div>
                <div class="play-btn" onclick="${isRav ? `loadData('Ravs/WebSite_GetRavShiurim/${id}/0/50/1/-1')` : `play('${id}', '${item.LivePubName || ''}')`}">
                    ${isRav ? '×œ×©×™×¢×•×¨×™× â†' : 'â–¶ × ×’×Ÿ'}
                </div>
            `;
            list.appendChild(div);
        });
    }

    async function play(id, liveName) {
        const status = document.getElementById('status');
        status.innerText = "××›×™×Ÿ ×©×™×“×•×¨...";
        
        try {
            let streamUrl = "";
            
            // ×× ×–×” ×©×™×“×•×¨ ×—×™, ×™×© ×œ×• LivePubName
            if (liveName && liveName.includes('@')) {
                const channel = liveName.split('@')[0];
                streamUrl = `https://live.kolhalashon.com/live/${channel}/playlist.m3u8`;
            } else {
                // ×œ×©×™×¢×•×¨×™× ××•×§×œ×˜×™× - × ×©×ª××© ×‘× ×ª×™×‘ ×”××¢×•×“×›×Ÿ
                const r = await fetch(PROXY + encodeURIComponent(`files/getLocationOfFileToVideo/${id}`));
                const d = await r.json();
                streamUrl = d.url || d;
            }

            if (streamUrl) {
                const player = document.getElementById('player');
                const v = document.getElementById('v');
                player.style.display = 'block';
                v.src = streamUrl;
                window.scrollTo(0,0);
                status.innerText = "";
            } else {
                status.innerText = "×œ× × ×™×ª×Ÿ ×œ× ×’×Ÿ ×§×•×‘×¥ ×–×”.";
            }
        } catch (e) {
            status.innerText = "×©×’×™××” ×‘× ×™×’×•×Ÿ.";
        }
    }

    function closePlayer() {
        const v = document.getElementById('v');
        v.pause();
        v.src = "";
        document.getElementById('player').style.display = 'none';
    }

    loadData('LiveShiurim/WebSite_GetLiveShiurim/1/true/true/30/-1');
</script>
</body>
</html>
