<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¨×›×– ×”×©×™×¢×•×¨×™× - ×§×•×œ ×”×œ×©×•×Ÿ</title>
    <style>
        :root { --primary: #1a73e8; --live: #d93025; --bg: #f8f9fa; }
        body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 15px; direction: rtl; }
        .container { max-width: 900px; margin: auto; background: white; padding: 25px; border-radius: 18px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        
        #player-box { display: none; margin-bottom: 25px; background: #000; border-radius: 15px; overflow: hidden; }
        .iframe-wrapper { position: relative; padding-top: 56.25%; }
        .iframe-wrapper iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }
        .close-btn { width: 100%; padding: 15px; background: #d93025; color: white; border: none; cursor: pointer; font-weight: bold; }

        .nav-bar { display: flex; gap: 10px; margin-bottom: 20px; }
        input { flex: 1; padding: 14px; border: 2px solid #eee; border-radius: 10px; font-size: 16px; outline: none; }
        button { padding: 12px 24px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; }
        .btn-search { background: var(--primary); color: white; }
        .btn-live { background: var(--live); color: white; }

        .item-card { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #f0f0f0; }
        .item-name { font-weight: 600; color: #333; }
        .action-btn { color: #1e8e3e; cursor: pointer; font-weight: bold; padding: 8px 16px; border: 2px solid #1e8e3e; border-radius: 8px; }
        
        #status-msg { text-align: center; color: #666; padding: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div id="player-box">
        <div class="iframe-wrapper">
            <iframe id="kol-player" allowfullscreen allow="autoplay"></iframe>
        </div>
        <button class="close-btn" onclick="closePlayer()">×¡×’×•×¨ × ×’×Ÿ Ã—</button>
    </div>

    <div class="nav-bar">
        <button class="btn-live" onclick="loadContent('LiveShiurim/WebSite_GetLiveShiurim/1/true/true/30/-1')">ğŸ”´ ×©×™×“×•×¨ ×—×™</button>
        <input type="text" id="search-input" placeholder="×—×™×¤×•×© ×¨×‘ ××• × ×•×©×...">
        <button class="btn-search" onclick="executeSearch()">×—×¤×©</button>
    </div>

    <div id="status-msg">×˜×•×¢×Ÿ...</div>
    <div id="results-list"></div>
</div>

<script>
    // ×× ×—× ×• ×¤×•× ×™× ×™×©×™×¨×•×ª ×œ×§×•×œ ×”×œ×©×•×Ÿ. ×”-CORS ×¢×œ×•×œ ×œ×”×¦×™×§ ×‘×—×œ×§ ××”×“×¤×“×¤× ×™×, 
    // ××‘×œ ×‘× ×˜×¤×¨×™ ×–×” ×œ×¨×•×‘ ×¢×•×‘×¨ ×›×™ ×”×©×¨×ª×™× ×©×œ×”× "×× ×§×™×" ×—×¡×™××•×ª ××¡×•×™××•×ª.
    const BASE_API = "https://www.kolhalashon.com/api/";

    async function loadContent(endpoint) {
        const status = document.getElementById('status-msg');
        status.innerText = "××ª×—×‘×¨ ×œ×§×•×œ ×”×œ×©×•×Ÿ...";
        
        try {
            // ×¤× ×™×™×” ×™×©×™×¨×” ×œ×œ× ×¤×¨×•×§×¡×™
            const res = await fetch(BASE_API + endpoint);
            if (!res.ok) throw new Error("Blocked");
            const data = await res.json();
            status.innerText = "";
            render(data);
        } catch (e) {
            status.innerText = "×©×’×™××” ×‘×’×™×©×” ×™×©×™×¨×”. ×× ×¡×” ×“×¨×š ×”×¤×¨×•×§×¡×™ ×›×’×™×‘×•×™...";
            // ×’×™×‘×•×™ ×œ××§×¨×” ×©×œ ×—×¡×™××ª CORS ×‘×“×¤×“×¤×Ÿ
            try {
                const proxyRes = await fetch("/api/proxy?endpoint=" + encodeURIComponent(endpoint));
                const proxyData = await proxyRes.json();
                render(proxyData);
                status.innerText = "";
            } catch (err) {
                status.innerText = "×—×¡×™××” ×¡×•×¤×™×ª ×©×œ ×§×•×œ ×”×œ×©×•×Ÿ. × ×¡×” ×œ×¨×¢× ×Ÿ ××ª ×”×“×£.";
            }
        }
    }

    function executeSearch() {
        const val = document.getElementById('search-input').value;
        if(val) loadContent(`Ravs/WebSite_GetRavs/1/${encodeURIComponent(val)}`);
    }

    function render(items) {
        const list = document.getElementById('results-list');
        list.innerHTML = '';
        if (!Array.isArray(items)) return;

        items.forEach(item => {
            const div = document.createElement('div');
            div.className = 'item-card';
            
            const name = item.UserNameHebrew || item.RavName || item.Title || item.ShiurTitle || "×©×™×¢×•×¨";
            const id = item.FileId || item.ShiurId || item.RavId;
            const isRav = !!item.RavId && !item.FileId;
            const liveId = item.LivePubName ? item.LivePubName.split('@')[0].replace('khl', '') : null;

            div.innerHTML = `
                <span class="item-name">${name}</span>
                <div class="action-btn" onclick="${isRav ? `loadContent('Ravs/WebSite_GetRavShiurim/${id}/0/50/1/-1')` : `play('${id}', '${liveId}')`}">
                    ${isRav ? '×œ×©×™×¢×•×¨×™× â†' : 'â–¶ × ×’×Ÿ'}
                </div>
            `;
            list.appendChild(div);
        });
    }

    function play(fileId, liveChannelId) {
        const box = document.getElementById('player-box');
        const iframe = document.getElementById('kol-player');
        
        let url = "";
        if (liveChannelId && liveChannelId !== "null") {
            url = `https://www.kolhalashon.com/NewLogos/PlayVideoV2.aspx?lp=${liveChannelId}&v=true`;
        } else {
            url = `https://www.kolhalashon.com/NewLogos/PlayVideoV2.aspx?FileID=${fileId}&v=true`;
        }

        box.style.display = 'block';
        iframe.src = url;
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function closePlayer() {
        document.getElementById('player-box').style.display = 'none';
        document.getElementById('kol-player').src = "";
    }

    loadContent('LiveShiurim/WebSite_GetLiveShiurim/1/true/true/30/-1');
</script>
</body>
</html>
