<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>× ×’×Ÿ ×§×•×œ ×”×œ×©×•×Ÿ</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f7f9; margin: 0; padding: 20px; direction: rtl; }
        .container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .header { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 15px; }
        input { flex-grow: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; }
        button { padding: 10px 20px; cursor: pointer; border: none; border-radius: 5px; font-weight: bold; transition: 0.3s; }
        .btn-search { background: #007bff; color: white; }
        .btn-live { background: #dc3545; color: white; }
        #player-section { display: none; margin-bottom: 20px; background: #000; padding: 10px; border-radius: 8px; }
        video { width: 100%; border-radius: 4px; }
        .item-card { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #eee; transition: 0.2s; }
        .item-card:hover { background: #f9f9f9; }
        .item-title { font-size: 15px; color: #333; flex-grow: 1; }
        .play-link { color: #28a745; cursor: pointer; font-weight: bold; text-decoration: none; }
        #status { color: #666; font-size: 14px; margin: 10px 0; }
    </style>
</head>
<body>

<div class="container">
    <div id="player-section">
        <div id="now-playing" style="color:white; margin-bottom:5px; font-size:12px;"></div>
        <video id="video-player" controls autoplay></video>
        <button onclick="closePlayer()" style="width:100%; margin-top:5px; background:#444; color:white;">×¡×’×•×¨ × ×’×Ÿ</button>
    </div>

    <div class="header">
        <button class="btn-live" onclick="loadLive()">ğŸ”´ ×©×™×“×•×¨×™× ×—×™×™×</button>
        <input type="text" id="search-input" placeholder="×—×¤×© ×¨×‘ ××• ×©×™×¢×•×¨...">
        <button class="btn-search" onclick="search()">×—×¤×©</button>
    </div>

    <div id="status">×˜×•×¢×Ÿ × ×ª×•× ×™×...</div>
    <div id="results-list"></div>
</div>

<script>
    const PROXY_URL = "/api/proxy?endpoint=";

    async function apiRequest(endpoint) {
        const status = document.getElementById('status');
        status.innerText = "××ª×—×‘×¨ ×œ×©×¨×ª...";
        try {
            const response = await fetch(PROXY_URL + encodeURIComponent(endpoint));
            const data = await response.json();
            if (data.error) throw new Error(data.details || data.error);
            status.innerText = "";
            return data;
        } catch (e) {
            status.innerText = "×©×’×™××”: " + e.message;
            console.error(e);
            return null;
        }
    }

    async function loadLive() {
        const data = await apiRequest("LiveShiurim/WebSite_GetLiveShiurim/1/true/true/30/-1");
        renderResults(data);
    }

    async function search() {
        const q = document.getElementById('search-input').value;
        if (!q) return;
        const data = await apiRequest("Ravs/WebSite_GetRavs/1/" + encodeURIComponent(q));
        renderResults(data, true);
    }

    async function loadRav(id) {
        const data = await apiRequest(`Ravs/WebSite_GetRavShiurim/${id}/0/50/1/-1`);
        renderResults(data);
    }

    function renderResults(items, isRavList = false) {
        const list = document.getElementById('results-list');
        list.innerHTML = '';
        if (!items || items.length === 0) {
            document.getElementById('status').innerText = "×œ× × ××¦××• ×ª×•×¦××•×ª.";
            return;
        }

        items.forEach(item => {
            const div = document.createElement('div');
            div.className = 'item-card';
            const title = item.Title || item.ShiurTitle || item.RavName;
            const id = item.ShiurId || item.FileId || item.RavId;
            
            div.innerHTML = `
                <span class="item-title">${title}</span>
                <span class="play-link" onclick="${isRavList ? `loadRav(${id})` : `playMedia('${id}', '${title.replace(/'/g, "\\'")}')`}">
                    ${isRavList ? '×”×¦×’ ×©×™×¢×•×¨×™× â†' : 'â–¶ × ×’×Ÿ'}
                </span>
            `;
            list.appendChild(div);
        });
    }

    async function playMedia(id, title) {
        const data = await apiRequest("files/getLocationOfFileToVideo/" + id);
        if (data) {
            const playerSection = document.getElementById('player-section');
            const video = document.getElementById('video-player');
            document.getElementById('now-playing').innerText = "×× ×’×Ÿ ×›×¢×ª: " + title;
            playerSection.style.display = 'block';
            video.src = data.url || data;
            window.scrollTo({top: 0, behavior: 'smooth'});
        }
    }

    function closePlayer() {
        document.getElementById('player-section').style.display = 'none';
        document.getElementById('video-player').pause();
    }

    // ×˜×¢×™× ×” ×¨××©×•× ×™×ª
    loadLive();
</script>
</body>
</html>
