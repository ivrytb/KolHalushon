<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¨×›×– ×”×©×™×¢×•×¨×™× - ×§×•×œ ×”×œ×©×•×Ÿ</title>
    <style>
        :root { --primary: #1a73e8; --live: #d93025; --bg: #f8f9fa; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); margin: 0; padding: 20px; direction: rtl; }
        .container { max-width: 850px; margin: auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        
        /* × ×’×Ÿ ×•×™×“××• */
        #player-box { display: none; margin-bottom: 25px; background: #000; border-radius: 12px; padding: 10px; overflow: hidden; }
        video { width: 100%; border-radius: 8px; background: #000; outline: none; }
        .close-btn { width: 100%; padding: 10px; background: #333; color: white; border: none; cursor: pointer; border-radius: 5px; margin-top: 8px; font-weight: bold; }

        /* ×—×™×¤×•×© ×•× ×™×•×•×˜ */
        .nav-bar { display: flex; gap: 10px; margin-bottom: 25px; flex-wrap: wrap; }
        input { flex: 1; min-width: 200px; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
        button { padding: 10px 22px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-search { background: var(--primary); color: white; }
        .btn-live { background: var(--live); color: white; }
        button:hover { opacity: 0.9; }

        /* ×¨×©×™××ª ×ª×•×¦××•×ª */
        .list-container { border-top: 1px solid #eee; }
        .item-card { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #f1f1f1; }
        .item-info { flex: 1; }
        .item-name { font-weight: bold; color: #202124; display: block; margin-bottom: 4px; }
        .item-sub { font-size: 13px; color: #5f6368; }
        .action-btn { color: #1e8e3e; cursor: pointer; font-weight: bold; padding: 8px 15px; border: 1px solid #1e8e3e; border-radius: 6px; white-space: nowrap; }
        .action-btn:hover { background: #e6f4ea; }

        #status-msg { text-align: center; padding: 10px; color: #70757a; font-size: 14px; }
    </style>
</head>
<body>

<div class="container">
    <div id="player-box">
        <video id="main-video" controls autoplay crossorigin="anonymous"></video>
        <button class="close-btn" onclick="closePlayer()">×¡×’×•×¨ × ×’×Ÿ Ã—</button>
    </div>

    <div class="nav-bar">
        <button class="btn-live" onclick="loadContent('LiveShiurim/WebSite_GetLiveShiurim/1/true/true/30/-1')">ğŸ”´ ×©×™×“×•×¨×™× ×—×™×™×</button>
        <input type="text" id="search-input" placeholder="×—×¤×© ×¨×‘, × ×•×©× ××• ××¡×›×ª...">
        <button class="btn-search" onclick="executeSearch()">×—×¤×©</button>
    </div>

    <div id="status-msg">×˜×•×¢×Ÿ ×××©×§...</div>

    <div id="results-list" class="list-container"></div>
</div>

<script>
    const PROXY_BASE = "/api/proxy?endpoint=";

    // ×¤×•× ×§×¦×™×” ×’× ×¨×™×ª ×œ××©×™×›×ª × ×ª×•× ×™×
    async function apiFetch(endpoint) {
        const status = document.getElementById('status-msg');
        status.innerText = "××ª×§×©×¨ ×¢× ×”×©×¨×ª...";
        try {
            const response = await fetch(PROXY_BASE + encodeURIComponent(endpoint));
            const data = await response.json();
            if (data.error) throw new Error(data.details);
            status.innerText = "";
            return data;
        } catch (e) {
            status.innerText = "×©×’×™××ª ×—×™×‘×•×¨. × ×¡×” ×©×•×‘.";
            console.error(e);
            return null;
        }
    }

    // ×˜×¢×™× ×ª ×ª×•×›×Ÿ (×©×™×“×•×¨×™× ×—×™×™× ××• ×¨×©×™××•×ª)
    async function loadContent(endpoint) {
        const data = await apiFetch(endpoint);
        renderItems(data);
    }

    // ×—×™×¤×•×© ×¨×‘× ×™×/×©×™×¢×•×¨×™×
    function executeSearch() {
        const q = document.getElementById('search-input').value;
        if (q) loadContent(`Ravs/WebSite_GetRavs/1/${encodeURIComponent(q)}/false`);
    }

    // ×”×¦×’×ª ×”×ª×•×¦××•×ª ×¢×œ ×”××¡×š
    function renderItems(items) {
        const list = document.getElementById('results-list');
        list.innerHTML = '';
        if (!items || items.length === 0) {
            document.getElementById('status-msg').innerText = "×œ× × ××¦××• ×ª×•×¦××•×ª.";
            return;
        }

        items.forEach(item => {
            const card = document.createElement('div');
            card.className = 'item-card';
            
            const name = item.UserNameHebrew || item.RavName || item.CatDesc1 || item.Title || "×©×™×¢×•×¨";
            const sub = item.MainTopicHebrew || item.CatDesc2 || "";
            const id = item.FileId || item.ShiurId || item.RavId;
            const isRav = !!item.RavId && !item.FileId;

            card.innerHTML = `
                <div class="item-info">
                    <span class="item-name">${name}</span>
                    <span class="item-sub">${sub}</span>
                </div>
                <div class="action-btn" onclick="${isRav ? `loadContent('Ravs/WebSite_GetRavShiurim/${id}/0/50/1/-1')` : `initPlayer('${id}', '${item.LivePubName || ''}')`}">
                    ${isRav ? '×œ×©×™×¢×•×¨×™× â†' : 'â–¶ × ×’×Ÿ'}
                </div>
            `;
            list.appendChild(card);
        });
    }

    // ×”×¤×¢×œ×ª ×”× ×’×Ÿ
    async function initPlayer(id, liveName) {
        const status = document.getElementById('status-msg');
        status.innerText = "××›×™×Ÿ ×§×•×‘×¥ ×œ× ×’×™× ×”...";
        
        try {
            let finalUrl = "";
            
            // ×‘×“×™×§×” ×× ××“×•×‘×¨ ×‘×©×™×“×•×¨ ×—×™
            if (liveName && liveName.includes('@')) {
                const channel = liveName.split('@')[0].replace('khl', '');
                finalUrl = `https://live.kolhalashon.com/live/khl${channel}/playlist.m3u8`;
            } else {
                // ×©×™×¢×•×¨ ××•×§×œ×˜
                const res = await apiFetch(`files/getLocationOfFileToVideo/${id}`);
                finalUrl = res.url || res;
            }

            if (finalUrl) {
                const playerBox = document.getElementById('player-box');
                const video = document.getElementById('main-video');
                
                playerBox.style.display = 'block';
                video.src = finalUrl;
                video.load();
                window.scrollTo({ top: 0, behavior: 'smooth' });
                status.innerText = "";
            }
        } catch (e) {
            status.innerText = "×©×’×™××”: ×”×§×•×‘×¥ ×—×¡×•× ××• ×œ× × ××¦×.";
        }
    }

    function closePlayer() {
        const video = document.getElementById('main-video');
        video.pause();
        video.src = "";
        document.getElementById('player-box').style.display = 'none';
    }

    // ×”×¤×¢×œ×” ×¨××©×•× ×™×ª
    window.onload = () => loadContent('LiveShiurim/WebSite_GetLiveShiurim/1/true/true/30/-1');
</script>

</body>
</html>
