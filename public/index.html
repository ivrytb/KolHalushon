<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>העלאה ישירה</title>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; display: flex; justify-content: center; align-items: center; height: 100vh; }
        .card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); width: 350px; text-align: center; }
        #status { margin-top: 20px; font-weight: bold; color: #4f46e5; }
    </style>
</head>
<body>
    <div class="card">
        <h3>העברה לימות המשיח</h3>
        <input type="text" id="link" placeholder="לינק מקול מבשר" style="width:100%; padding:10px; margin-bottom:10px;">
        <button onclick="upload()" id="btn" style="width:100%; padding:10px; background:#4f46e5; color:white; border:none; border-radius:5px; cursor:pointer;">בצע העלאה</button>
        <div id="status"></div>
    </div>

    <script>
        async function upload() {
            const status = document.getElementById('status');
            const btn = document.getElementById('btn');
            const link = document.getElementById('link').value;
            if(!link) return;

            btn.disabled = true;
            status.innerText = "מוריד קובץ לזיכרון הדפדפן...";

            try {
                // 1. קבלת הטוקן
                const conf = await (await fetch('/api/get_config')).json();
                
                // 2. הורדת הקובץ (דרך השרת שלך כדי לעקוף חסימת דפדפן, אבל כ-Blob)
                // הערה: כאן נטפרי עלול לחסום אם הקובץ ענק. 
                // אם זה קורה, הפתרון היחיד הוא לבקש מנטפרי אישור לדומיין שלך.
                const audioRes = await fetch(`/api/stream_audio?url=${encodeURIComponent(link)}`);
                const blob = await audioRes.blob();

                status.innerText = "מעלה לימות המשיח (לפי התיעוד)...";

                // 3. בניית הטופס בדיוק לפי התיעוד ששלחת
                const formData = new FormData();
                formData.append('token', conf.token);
                formData.append('path', `ivr2:KolMevaser/${Date.now()}.wav`);
                formData.append('convertAudio', '1');
                formData.append('qqfile', blob, "audio.mp3"); // הפרמטר שבו נמצא הקובץ

                const ymRes = await fetch('https://www.call2all.co.il/ym/api/UploadFile', {
                    method: 'POST',
                    body: formData // שליחה כ-multipart/form-data
                });

                const result = await ymRes.json();
                if(result.status === 'success') {
                    status.innerText = "הצלחנו! הקובץ בימות המשיח.";
                } else {
                    status.innerText = "שגיאה מימות: " + result.message;
                }
            } catch (e) {
                status.innerText = "שגיאה: " + e.message;
            } finally {
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
