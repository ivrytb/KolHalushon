<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>הורדת שיעורים פרימיום</title>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --p: #6366f1; --s: #10b981; --err: #ef4444; }
        body { font-family: 'Assistant', sans-serif; background: #f1f5f9; display: flex; align-items: center; justify-content: center; min-height: 100vh; margin: 0; }
        .card { background: white; padding: 40px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 450px; text-align: center; border: 1px solid #fff; }
        h2 { color: #1e1b4b; margin: 0 0 10px 0; font-size: 28px; font-weight: 800; }
        .sub { color: var(--p); margin-bottom: 25px; font-weight: 600; font-size: 18px; }
        input { width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 12px; margin-bottom: 20px; box-sizing: border-box; font-family: inherit; font-size: 15px; }
        input:focus { outline: none; border-color: var(--p); }
        button { background: var(--p); color: white; border: none; padding: 18px; border-radius: 12px; width: 100%; font-weight: 800; cursor: pointer; font-size: 18px; transition: 0.2s; }
        button:hover { background: #4f46e5; transform: translateY(-1px); }
        button:disabled { background: #cbd5e1; cursor: not-allowed; transform: none; }
        
        #status-box { margin-top: 25px; text-align: right; background: #f8fafc; padding: 20px; border-radius: 15px; border: 1px solid #e2e8f0; display: none; }
        .log-line { font-size: 13px; color: #64748b; font-family: monospace; border-bottom: 1px solid #f1f5f9; padding: 4px 0; line-height: 1.4; }
        .progress-bar { height: 10px; background: #e2e8f0; border-radius: 10px; margin: 15px 0; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--p); width: 0%; transition: 0.3s; }
        #main-msg { font-weight: 800; color: #1e1b4b; margin-bottom: 5px; }
        .done-link { display: inline-block; margin-top: 10px; background: var(--s); color: white; text-decoration: none; padding: 10px 20px; border-radius: 10px; font-weight: 700; }
    </style>
</head>
<body>
    <div class="card">
        <h2>הורדת שיעורים</h2>
        <div class="sub">הזרמה ישירה למערכת ימות המשיח</div>
        
        <input type="text" id="urlInput" placeholder="הדבק כאן לינק מקול מבשר (Yiddish24)..." spellcheck="false">
        <button id="mainBtn" onclick="process()">התחל הורדה והעתקה</button>

        <div id="status-box">
            <div id="main-msg">ממתין לפקודה...</div>
            <div class="progress-bar"><div id="fill" class="progress-fill"></div></div>
            <div id="logs" style="max-height: 180px; overflow-y: auto; display: flex; flex-direction: column;"></div>
        </div>
    </div>

    <script>
        const logsDiv = document.getElementById('logs');
        const mainMsg = document.getElementById('main-msg');
        const fill = document.getElementById('fill');
        const btn = document.getElementById('mainBtn');

        function addLog(msg, isError = false) {
            const div = document.createElement('div');
            div.className = 'log-line';
            if(isError) div.style.color = '#ef4444';
            div.innerText = `[${new Date().toLocaleTimeString('he-IL')}] ${msg}`;
            logsDiv.prepend(div);
            console.log(msg);
        }

        async function process() {
            const url = document.getElementById('urlInput').value.trim();
            if(!url) return alert("נא להזין לינק תקין");

            // איפוס ממשק
            btn.disabled = true;
            document.getElementById('status-box').style.display = 'block';
            logsDiv.innerHTML = '';
            fill.style.width = '0%';
            mainMsg.innerText = "מתחיל תהליך...";
            
            try {
                addLog("מושך הגדרות אבטחה מהשרת...");
                const confReq = await fetch('/api/get_config');
                const config = await confReq.json();

                if(!config.token) throw new Error("חסר טוקן (YM_TOKEN) בשרת!");

                addLog("מתחבר לזרם האודיו (זה עשוי לקחת כמה שניות)...");
                const response = await fetch(`/api/stream_audio?url=${encodeURIComponent(url)}`);
                
                if(!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`שגיאת שרת: ${response.status} - ${errorText}`);
                }

                // קריאת הזרם (Stream) לתוך הזיכרון
                const reader = response.body.getReader();
                let chunks = [];
                let receivedLength = 0;

                while(true) {
                    const {done, value} = await reader.read();
                    if (done) break;
                    chunks.push(value);
                    receivedLength += value.length;
                    mainMsg.innerText = `טוען לזיכרון: ${(receivedLength/1024/1024).toFixed(1)}MB`;
                }

                addLog(`הקובץ נטען בהצלחה (${(receivedLength/1024/1024).toFixed(1)}MB).`);
                
                const blob = new Blob(chunks);
                const totalSize = blob.size;
                const uuid = crypto.randomUUID();
                const fileName = `${Math.floor(Date.now()/1000)}.wav`;
                const chunkSize = 5 * 1024 * 1024; // 5MB לכל חלק
                const totalParts = Math.ceil(totalSize / chunkSize);

                addLog(`מתחיל העלאה לימות המשיח ב-${totalParts} חלקים...`);

                for (let i = 0; i < totalParts; i++) {
                    const start = i * chunkSize;
                    const end = Math.min(start + chunkSize, totalSize);
                    const chunk = blob.slice(start, end);

                    const fd = new FormData();
                    fd.append('token', config.token);
                    fd.append('path', `ivr2:KolMevaser/${fileName}`);
                    fd.append('qquuid', uuid);
                    fd.append('qqpartindex', i);
                    fd.append('qqpartbyteoffset', start);
                    fd.append('qqchunksize', chunk.size);
                    fd.append('qqtotalparts', totalParts);
                    fd.append('qqtotalfilesize', totalSize);
                    fd.append('qqfilename', fileName);
                    fd.append('qqfile', chunk);

                    const upRes = await fetch('https://www.call2all.co.il/ym/api/UploadFile', {
                        method: 'POST',
                        body: fd
                    });
                    
                    const upData = await upRes.json();
                    
                    const pct = Math.round(((i + 1) / totalParts) * 100);
                    fill.style.width = pct + '%';
                    mainMsg.innerText = `מעלה לימות המשיח: ${pct}%`;
                    addLog(`חלק ${i+1}/${totalParts} עלה.`);
                }

                addLog("ממתין לאיחוד קבצים והמרה (זה עשוי לקחת זמן בקבצים גדולים)...");
                const doneUrl = `https://www.call2all.co.il/ym/api/UploadFile?done&token=${config.token}&path=ivr2:KolMevaser/${fileName}&qquuid=${uuid}&qqtotalfilesize=${totalSize}&qqtotalparts=${totalParts}&convertAudio=1`;
                
                const finalRes = await fetch(doneUrl);
                const finalData = await finalRes.json();
                
                addLog("תשובה סופית: " + JSON.stringify(finalData));

                if(finalData.status === 'success' || finalData.success) {
                    mainMsg.innerText = "התהליך הושלם!";
                    const dlUrl = `https://www.call2all.co.il/ym/api/DownloadFile?token=${config.token}&path=ivr2:KolMevaser/${fileName}`;
                    addLog("מוריד את הקובץ המומר אליך...");
                    
                    const finishDiv = document.createElement('div');
                    finishDiv.innerHTML = `<a href="${dlUrl}" class="done-link" download="${fileName}">לחץ כאן אם ההורדה לא התחילה</a>`;
                    logsDiv.prepend(finishDiv);
                    
                    window.location.href = dlUrl;
                } else {
                    throw new Error(finalData.message || "ימות המשיח נתנו שגיאה באיחוד");
                }

            } catch (e) {
                addLog(e.message, true);
                mainMsg.innerText = "שגיאה בתהליך";
                console.error(e);
            } finally {
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
